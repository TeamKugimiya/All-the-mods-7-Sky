name: Auto Package

on:
  push:
    branches:
    - main
    paths:
    - "ATM7-To_The_Sky/**"
  workflow_dispatch: {}

jobs:
  Packer:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        full_name: [ "ATM7 To The Sky" ]
        file_name: [ "ATM7-ToTheSky" ]
        folder_path: [ "ATM7-To_The_Sky" ]

    steps:
      - name: Checking Repostiory
        uses: actions/checkout@v2.0.0
        with:
          fetch-depth: 0
      
      - name: Make Resourcepack Step 01 (${{ matrix.full_name }})
        run: |
          mkdir workdir
          cp -r ${{ matrix.folder_path }}/kubejs/assets workdir
          cp LICENSE workdir
          echo "{\"pack\":{\"pack_format\":8,\"description\":\"Â§3æ¨¡çµ„ä»»å‹™ç¿»è­¯åŒ…\nÂ§b${{ matrix.full_name }}\"}}" > workdir/pack.mcmeta

      - name: Make Resourcepack Step 02 (${{ matrix.full_name }})
        uses: ComunidadAylas/PackSquash-action@master
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          force_include_files: LICENSE
          never_store_squash_times: true
          path: ./workdir

      - name: Make Resourcepack Step 03 (${{ matrix.full_name }})
        uses: actions/download-artifact@v2
        with:
          name: Optimized pack
          path: ./

      - name: Make Resourcepack Step 04 (${{ matrix.full_name }})
        run: |
          mv ./pack.zip QuestsTranslationPack-${{ matrix.file_name }}.zip

      - name: Delete Artifact
        uses: geekyeggo/delete-artifact@v1
        with:
          name: |
            Optimized pack
      
      - name: Fix FTBQuest path (${{ matrix.full_name }}-Config)
        run: |
          cd ${{ matrix.folder_path }}/config
          mv ftbquests quests
          mkdir ftbquests
          mv quests ftbquests

      - name: Remove backup & kubejs folder (${{ matrix.full_name }}-Config)
        run: |
          cd ${{ matrix.folder_path }}
          rm -r backup
          rm -r kubejs

      - name: Make ConfigPack (${{ matrix.full_name }})
        run: |
          cd ${{ matrix.folder_path }}
          zip -r ../QuestsTranslationPack-${{ matrix.file_name }}-Config.zip *

      - name: Make Checksum
        id: checksum
        run: |
          echo "::set-output name=sum-01::$(sha256sum QuestsTranslationPack-${{ matrix.file_name }}.zip)"
          echo "::set-output name=sum-02::$(sha256sum QuestsTranslationPack-${{ matrix.file_name }}-Config.zip)"

      - name: Make Git Version
        id: version
        run: |
          echo "::set-output name=sha_short::${GITHUB_SHA::7}"

      - name: Make Current Time
        id: current_time
        run: |
          echo "::set-output name=time::$(TZ='Asia/Taipei' date +'æœ€å¾Œæ›´æ–°ï¼š%Y å¹´ %m æœˆ %d æ—¥ %H é» %M åˆ†')"

      - name: Push Pack to Release
        uses: ncipollo/release-action@v1
        with:
          allowUpdates: true
          artifacts: "*.zip"
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: latest
          name: æ¨¡çµ„ä»»å‹™ç¿»è­¯åŒ… (git ${{ steps.version.outputs.sha_short }})
          body: |
            ## ğŸ“ å®‰è£

            ### ç”¨æˆ¶ç«¯
            ä¸‹è¼‰ `QuestsTranslationPack-ATM7-ToTheSky.zip`
            ä¸¦æ”¾åˆ°è³‡æºåŒ…è³‡æ–™å¤¾ä¸­ï¼Œåœ¨éŠæˆ²åŠ è¼‰å³å¯å®Œæˆï¼
            
            ### ä¼ºæœå™¨ç«¯ï¼å–®äººéŠæˆ²
            å¦‚æœä½ æ˜¯å–®äººéŠæˆ²æˆ–æ˜¯å¤šäººéŠæˆ²
            éœ€å°‡æŠŠä»»å‹™çš„è®Šæ•¸åŒ…è£å…¥ä¼ºæœå™¨
            å°‡ `QuestsTranslationPack-ATM7-ToTheSky-Config.zip`
            è§£å£“ç¸®åˆ° `minecraft/` è³‡æ–™å¤¾ä¸­è¦†è“‹ `config` è³‡æ–™å¤¾å…§çš„
            FTBQuest å³å¯å®Œæˆï¼

            ## â­ æ›´æ–°
            åƒ…éœ€è¦ä¸‹è¼‰æœ€æ–°è³‡æºåŒ…å¥—ç”¨å³å¯ï¼

            > ${{ steps.current_time.outputs.time }}

            ## âœ… Checksum
            ```
            ${{ steps.checksum.outputs.sum-01 }}
            ${{ steps.checksum.outputs.sum-02 }}
            ```
